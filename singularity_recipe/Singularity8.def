Bootstrap: docker
From: ubuntu:22.04

%labels
  Author Sedona Ewbank
  Version v1.0

%post
  apt update && apt install -y \
    wget \
    unzip \
    xvfb \
    curl \
    cmake \
    ninja-build \
    git \
    libqt6charts6-dev \
    libglu1-mesa \
    libqt6core6 \
    libqt6gui6 \
    libqt6widgets6 \
    zlib1g-dev \
    qt6-base-dev \
    libqt6opengl6-dev \
    qt6-image-formats-plugins \
    && rm -rf /var/lib/apt/lists/*

  strip --remove-section=.note.ABI-tag /usr/lib/x86_64-linux-gnu/libQt6Core.so.6
  
  # Create X11-unix directory and set correct permissions
  mkdir -p /tmp/.X11-unix
  chmod 1777 /tmp/.X11-unix
  chown root:root /tmp/.X11-unix  # Fix ownership for Xvfb
  
  wget https://github.com/frankyeh/DSI-Studio/releases/download/2024.06.12/dsi_studio_ubuntu2204.zip -O /tmp/dsi_studio.zip
  unzip /tmp/dsi_studio.zip -d /opt/dsi_studio
  rm /tmp/dsi_studio.zip
  ln -s /opt/dsi_studio/dsi-studio/dsi_studio /usr/local/bin/dsi_studio

%environment
  # Set environment variables
  export DEBIAN_FRONTEND=noninteractive
  export DISPLAY=:99
  export QT_QPA_PLATFORM=offscreen
  export LD_LIBRARY_PATH=/usr/lib/x86_64-linux-gnu:/.singularity.d/libs
  export XKB_DEFAULT=disable  # Prevent XKB-related error

%runscript
  Xvfb :99 -screen 0 1024x768x16 -nolisten tcp -noreset &
  xvfb_pid=$!
  sleep 2
  "$@"
  kill $xvfb_pid